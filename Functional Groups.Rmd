---
title: "Function groups diversity"
author: "JayToh"
date: '2023-05-17'
output: html_document
---

# Library:
```{r, warning = FALSE}
library(dplyr)
library(ggplot2)
library(StatisticalModels)
library(predictsFunctions)
library(janitor)
library(ggpubr)
library(openxlsx)
library(tidyr)
library(DHARMa)
library(tibble)

select <- dplyr::select

```

# Data:
1. Read in FG sorted-data
2. Remove lands whose land use and use intensity cannot be decided

```{r}

load("../2. Grouping/1_Animal classification/SitesTrophicLevels.Rd") 



Plants <- read.csv("PlantFG.csv") %>%  dplyr::filter(!(Predominant_land_use == "Cannot decide")) %>% dplyr::filter(!(Use_intensity == "Cannot decide"))

Fungi <- read.csv("FungiFG.csv") %>% dplyr::filter(!(Predominant_land_use == "Cannot decide")) %>% dplyr::filter(!(Use_intensity == "Cannot decide"))


```

# Simplify DF:
1. Merge fine classifications of secondary vegetation (including young, intermediate, mature) to "SV"
2. Simplify names
3. Factor SS, Source ID and SS
```{r}
############# Function that simplify names #############
Ezsimplify <- function(df) {
  A <- df %>% mutate(Land_use = Predominant_land_use) %>% relocate(Land_use, .after = Predominant_land_use) %>% relocate(Use_intensity, .after = Land_use) %>% mutate(Intensity = Use_intensity) %>% relocate(Intensity, .after = Use_intensity)
  A$Land_use <- dplyr::recode(A$Predominant_land_use,
                                                       "Primary vegetation" = "PV",
                                                       "Young secondary vegetation" = "SV",
                                                       "Intermediate secondary vegetation" = "SV",
                                                       "Mature secondary vegetation" = "SV",
                                                       "Secondary vegetation (indeterminate age)" = "SV",
                                                       "Plantation forest" = "Plantation",
                                                       "Cropland" = "Crop")
  A$Intensity <- dplyr::recode(A$Use_intensity,
                                                       "Minimal use" = "Minimal",
                                                       "Light use" = "Light",
                                                       "Intense use" = "Intense")
  A$SSS <- factor(A$SSS)
  A$Source_ID <- factor(A$Source_ID)
  A$SS <- factor(A$SS)
  A
}

############# Function that simplify names #############
Producers <- Ezsimplify(Plants) %>% select(-X, -X.1)
Decomposers <- Ezsimplify(Fungi) %>% select(-X, -X.1)
```

# Diversity for each FG
## Functions
```{r}
############# Function for Abundance, spp richness, Chao and Rarefied. Takes long to run!  #############

Ezdiversity <- function(df){
  A <- predictsFunctions::SiteMetrics(diversity = df,
                                      extra.cols = c("Longitude",
                                                     "Latitude",
                                                     "Land_use",
                                                     "Intensity",
                                                     "SSB",
                                                     "SSBS",
                                                     "Years_since_fragmentation_or_conversion",
                                                     "Country",
                                                     "Biome",
                                                     "Habitat_patch_area_square_metres",
                                                     "Km_to_nearest_edge_of_habitat",
                                                     "FG_Final"))
  A$Land_use <- factor(A$Land_use, levels = c("PV", "SV", "Plantation", "Pasture", "Crop", "Urban"))
  A$Intensity <- factor(A$Intensity, levels = c("Minimal", "Light", "Intense"))
  A
}
```

## Plant CSR
1. C, S, and R SiteMetric function for each function group
2. Drop level
3.SiteMetric
4. EzdiversityFG

```{r}
################################### Diversity for each TL. ###################################
# EzdiversityFG

EzdiversityFG <- function(DF, strategy) {
  A <- DF
  B <- droplevels(A)
  C <- Ezdiversity(B)
  D <- C %>% mutate(FG = strategy) %>% relocate(FG)
}
Plant_C_Diversity <- EzdiversityFG(Plant_C, "C")
Plant_S_Diversity <- EzdiversityFG(Plant_S, "S")
Plant_R_Diversity <- EzdiversityFG(Plant_R, "R")

# Final dataset here
Plant_FG <- rbind(Plant_C_Diversity, Plant_R_Diversity, Plant_S_Diversity)

######## Raw ########
Plant_C <- Producers %>% filter(CSR_Final == "C")
Plant_S <- Producers %>% filter(CSR_Final == "S")
Plant_R <- Producers %>% filter(CSR_Final == "R")
Plant_C <- droplevels(Plant_C)
Plant_S <- droplevels(Plant_S)
Plant_R <- droplevels(Plant_R)

```

## Fungi Saprotroph, symbiotroph, pathotroph
```{r}

Fungi_Sym <- Decomposers %>% filter(FG_Final == "Symbiotroph")
Fungi_Sapro <- Decomposers %>% filter(FG_Final == "Saprotroph")
Fungi_Path <- Decomposers %>% filter(FG_Final == "Pathotroph")

Fungi_Sym_Diversity <- EzdiversityFG(Fungi_Sym, "Symbiotroph")
Fungi_Sapro_Diversity <- EzdiversityFG(Fungi_Sym, "Saprotroph")
Fungi_Path_Diversity <- EzdiversityFG(Fungi_Sym, "Pathotroph")


# Final dataset here
Fungi_FG <- rbind(Fungi_Sym_Diversity, Fungi_Sapro_Diversity, Fungi_Path_Diversity)

```
## Animals
```{r}
Animal_FG <- sites %>% rownames_to_column(var = "FG") %>% tidyr::separate("FG", into = c("FG_only", "ID"))

```

## Exporting:
```{r}
write.csv(Animal_FG, "AnimalFG.csv")
write.csv(Plant_FG, "PlantFG.csv")
write.csv(Fungi_FG, "FungiFG.csv")

```

